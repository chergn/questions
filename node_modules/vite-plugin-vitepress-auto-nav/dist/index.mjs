import{normalize as t,sep as e,join as i,resolve as n,extname as o}from"path";import{utimesSync as s,existsSync as r}from"fs";import{readFile as m,stat as a,mkdir as c,writeFile as l}from"fs/promises";import f from"fast-glob";import d from"gray-matter";import{spawn as p}from"child_process";async function h(t,e){const i=$[t];if(i){if((await a(t)).mtimeMs===i.options.modifyTime){const{birthTime:t,modifyTime:e,firstCommitTime:n,lastCommitTime:o}=i.options;return{birthTime:t,modifyTime:e,firstCommitTime:n,lastCommitTime:o}}}const{birthtimeMs:n,mtimeMs:o}=await a(t);return new Promise((async i=>{if(e)return void i({birthTime:n,modifyTime:o});let s=[];const r=p("git",["--no-pager","log",'--pretty="%ci"',t]);r.stdout.on("data",(t=>{const e=String(t).split("\n").map((t=>+new Date(t))).filter((t=>t));s.push(...e)})),r.on("close",(async()=>{s.length?i({lastCommitTime:+new Date(s[s.length-1]),firstCommitTime:+new Date(s[0]),birthTime:n,modifyTime:o}):i({birthTime:n,modifyTime:o})})),r.on("error",(async()=>{i({birthTime:n,modifyTime:o})}))}))}function u(t){s(t,new Date,new Date)}function g(t,e,i){return t[`nav-${i}`]??t[i]??e[i]}function T(t){let e,i;for(const n of t)if(n.isFolder){const t=T(n.children);e=Math.min(e??1/0,t.minFirstCommitTime??1/0),i=Math.max(i??0,t.maxLastCommitTime??0)}else e=Math.min(e??1/0,n.options.firstCommitTime??1/0),i=Math.max(i??0,n.options.lastCommitTime??0);return{minFirstCommitTime:e===1/0?void 0:e,maxLastCommitTime:0===i?void 0:i}}function v(t){for(const e of t)if(e.isFolder){v(e.children);const t=T(e.children);e.options.firstCommitTime=t.minFirstCommitTime,e.options.lastCommitTime=t.maxLastCommitTime}}function y(t,e=b){return t.map(((t,i)=>(t.index=i,t.children&&t.children.length>0&&(t.children=y(t.children,e)),t))).sort(e)}function b(t,e){const i=g(t.frontmatter,t.options,"sort"),n=g(e.frontmatter,e.options,"sort"),o=t.options.firstCommitTime||t.options.birthTime,s=e.options.firstCommitTime||e.options.birthTime;return void 0!==i&&void 0!==n?i-n||o-s:void 0!==i&&void 0===n?i===e.index?-1:i-e.index:void 0===i&&void 0!==n?n===t.index?1:t.index-n:o-s}function w(t,e=""){return e+=`/${t.name}`,t.children.length>0?w(t.children[0],e):e.replace(".md","")}async function x(t){const e=$[t];if(e){if((await a(t)).mtimeMs===e.options.modifyTime)return e.frontmatter}const i=await m(t,{encoding:"utf-8"}),{content:n,data:o}=d(i);return o.h1=C(n,o),o}function C(t,e){let i=t.match(/^\s*#\s+(.*)[\n\r][\s\S]*/)?.[1];if(i){const t=/\{\{\s*\$frontmatter\.(\S+?)\s*\}\}/g;let n;for(;null!==(n=t.exec(i));){const t=new RegExp("\\{\\{\\s*\\$frontmatter\\."+n[1]+"\\s*\\}\\}","g");i=i.replace(t,e[n[1]])}}return i}let $={};const M=new Set;function k(s={}){return{name:"vite-plugin-vitepress-auto-nav",async configureServer({config:e,watcher:i}){const{vitepress:{configPath:n}}=e,o=n?.match(/(\.vitepress.*)/)?.[1]||".vitepress/config.ts",r=function(t,e){let i,n=0;return function(...o){const s=Date.now(),r=s-n;r>=e?(t.apply(this,o),n=s):(clearTimeout(i),i=setTimeout((()=>{t.apply(this,o),n=Date.now()}),e-r))}}(S.bind(null,o),1500);i.on("all",((e,i)=>{s.summary?.target&&t(i)===t(s.summary.target)?u(o):r(e,i)}))},async config(a){const{vitepress:{userConfig:{srcExclude:d=[],srcDir:p="./"},site:{themeConfig:{nav:u}},cacheDir:T}}=a;if(s.summary){console.log("🎈 SUMMARY 解析中...");const{sidebar:e,nav:i}=await async function(e){const{target:i,collapsed:n,removeEscape:o=!0}=e,s=(await m(t(i),{encoding:"utf-8"})).split(/\r?\n/).filter((t=>t.trim())),r=[],a=[],c=[];let l;for(let t=0;t<s.length;t++){let e=c[c.length-1];const i=s[t],m=i.trim();if(m.startsWith("#")){let[t,s,m]=/^\s*(#+)\s+(.+?)\s*$/.exec(i)||[];if(!s||!m)continue;m=o?m.replace(/\\/g,""):m;const l=-s.length,f={text:m,items:[],collapsed:n};if(-1===l)r.push(f),c.push({depth:l,sidebarItem:f}),a.push({text:m,link:""});else{for(;e&&(e.depth>=0||e.depth<=l);)c.pop(),e=c[c.length-1];e?.sidebarItem&&(e.sidebarItem.items?.push(f),c.push({depth:l,sidebarItem:f}))}}else if(m.startsWith("*")||m.startsWith("-")){let[t,s,r,m]=/^(\s*)[\*\-]\s+\[(.+)\]\((.+).md\)\s*$/.exec(i)||[];if(!m)continue;m.startsWith("/")||(m=`/${m}`),r=o?r.replace(/\\/g,""):r;const f={text:r,link:m,items:[],collapsed:n};void 0===l&&s&&(l=s);const d=s?s.length/l.length:0;for(;e&&e.depth>=d;)c.pop(),e=c[c.length-1];e?.sidebarItem&&(e.sidebarItem.items?.push(f),c.push({depth:d,sidebarItem:f}),a.length&&!a[a.length-1].link&&(a[a.length-1].link=m))}}return{sidebar:r,nav:a}}(s.summary);return a.vitepress.site.themeConfig.sidebar=e,u||(a.vitepress.site.themeConfig.nav=i),console.log("🎈 SUMMARY 解析完成..."),a}console.log("🎈 auto-nav 生成中..."),M.clear(),r(T)||await c(T);try{const t=await m(`${T}/auto-nav-cache.json`,{encoding:"utf-8"});$=JSON.parse(t)||{}}catch(t){}const b=s.pattern||"**.md",C=(await f(b,{cwd:p,ignore:["**/node_modules/**","**/dist/**","index.md",...d]})).map((e=>t(e)));let k=await async function(s,{itemsSetting:r={},useArticleTitle:m},a){const c={};for(const e in r)c[t(e)]=r[e];const l=Object.keys(c),f=[];for(const t of s){let s=f,r="";const d=t.split(e);for(const t of d){r=i(r,t);const e=n(a,r),f=!o(t);let d={useArticleTitle:m},p=l.find((t=>r===t));if(null==p&&(p=l.find((e=>t===e||t.replace(".md","")===e))),null!=p){const{collapsed:t,hide:e,sort:i,title:n,useArticleTitle:o}=c[p];d={collapsed:t,hide:e,sort:i,title:n,useArticleTitle:o??d.useArticleTitle}}const u=await h(e,f);d={...d,...u};let T={};if(f||(T=await x(e)),$[e]={options:d,frontmatter:T},M.add(e),g(T,d,"hide"))break;let v=s.find((e=>e.name===t));v||(v={index:0,name:t,isFolder:f,options:d,frontmatter:T,children:[]},s.push(v)),s=v.children}}return f}(C,s,p);v(k),k=y(k,s.compareFn),u||(a.vitepress.site.themeConfig.nav=k.map((t=>({text:t.options.title||t.name,activeMatch:`/${t.name}/`,link:w(t)}))));const S=function(t){const e={};for(const{name:n,children:o}of t)e[`/${n}/`]=i(o,`/${n}`);function i(t,e){return t.map((t=>{const n=`${e}/${t.name}`,o=g(t.frontmatter,t.options,"title")||g(t.frontmatter,t.options,"useArticleTitle")&&t.frontmatter.h1||t.name.replace(".md","");return t.isFolder?{text:o,collapsed:t.options.collapsed??!1,items:i(t.children,n)}:{text:o,link:n.replace(".md","")}}))}return e}(k);a.vitepress.site.themeConfig.sidebar=S;for(let t in $)M.has(t)||delete $[t];return l(`${T}/auto-nav-cache.json`,JSON.stringify($)),console.log("🎈 auto-nav 生成完成"),a}}}async function S(t,e,i){if(i.endsWith(".md"))if("change"===e&&$[i]){const e=await m(i,{encoding:"utf-8"}),{content:n,data:o}=d(e);if(o.h1=C(n,o),Object.keys(o).length!==Object.keys($[i].frontmatter).length)return void u(t);for(let e in o)if($[i].frontmatter[e]!==o[e])return void u(t)}else u(t)}export{$ as cache,k as default,M as visitedCache};
